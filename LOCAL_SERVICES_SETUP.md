# AVR Local Development Services Setup

This guide explains how to run all AVR services locally for development and testing.

## Prerequisites

1. **Docker Desktop** - Must be installed and running
   - Download from: https://www.docker.com/products/docker-desktop
   - Make sure Docker Desktop is running before starting services

2. **Node.js 18+** - For running the frontend and backend locally
   - Already installed if you've run `setup_local_dev.ps1`

## Services Overview

The local development setup includes:

- **avr-asterisk** - PBX server for handling SIP calls
  - SIP: `localhost:5060`
  - AMI: `localhost:5038`
  - ARI HTTP: `localhost:8088`
  - ARI WebSocket: `localhost:8089`
  - RTP: `10000-10050/udp`

- **avr-ami** - Asterisk Manager Interface service
  - HTTP API: `http://localhost:6006`
  - Used by agents for call control (hangup, transfer, originate)

- **avr-phone** - WebRTC phone client
  - Web interface: `http://localhost:8080`
  - For testing calls in the browser

## Quick Start

### 1. Start Infrastructure Services

```powershell
.\start_services.ps1
```

This will:
- Check if Docker is running
- Start avr-asterisk, avr-ami, and avr-phone containers
- Display service status

### 2. Start Frontend and Backend

In separate terminals:

```powershell
# Terminal 1 - Backend
cd avr-app\backend
npm run start:dev

# Terminal 2 - Frontend
cd avr-app\frontend
npm run dev
```

Or use the convenience script:

```powershell
.\start_dev.ps1
```

### 3. Access the Application

- **Frontend**: http://localhost:3000
- **Backend API**: http://localhost:3001
- **Web Phone**: http://localhost:8080
- **Asterisk ARI**: http://localhost:8088/ari
- **AMI Service**: http://localhost:6006

## Service Management

### View Service Logs

```powershell
# All services
docker-compose -f docker-compose-local-dev.yml logs -f

# Specific service
docker-compose -f docker-compose-local-dev.yml logs -f avr-asterisk
docker-compose -f docker-compose-local-dev.yml logs -f avr-ami
```

### Check Service Status

```powershell
docker-compose -f docker-compose-local-dev.yml ps
```

### Stop Services

```powershell
.\stop_services.ps1
```

Or manually:

```powershell
docker-compose -f docker-compose-local-dev.yml down
```

### Restart Services

```powershell
.\stop_services.ps1
.\start_services.ps1
```

## Configuration

### Backend Environment Variables

The backend `.env` file (in `avr-app/backend/.env`) should have:

```env
# Database
DB_PATH=./data/avr.db

# JWT
JWT_SECRET=<auto-generated>
JWT_EXPIRES_IN=7d

# Server
PORT=3001
FRONTEND_URL=http://localhost:3000

# Docker
DOCKER_SOCKET_PATH=//./pipe/docker_engine

# Asterisk ARI
ARI_URL=http://localhost:8088/ari
ARI_USERNAME=asterisk
ARI_PASSWORD=asterisk

# Webhooks
WEBHOOK_URL=http://localhost:3001/webhooks
WEBHOOK_SECRET=<auto-generated>

# AMI
AMI_URL=http://localhost:6006
```

### Frontend Environment Variables

The frontend `.env.local` file (in `avr-app/frontend/.env.local`) should have:

```env
NEXT_PUBLIC_API_URL=http://localhost:3001
NEXT_PUBLIC_WEBRTC_CLIENT_URL=http://localhost:8080
```

## Testing the Setup

### 1. Create a Provider

1. Open http://localhost:3000
2. Login with:
   - Username: `admin@agentvoiceresponse.com`
   - Password: `agentvoiceresponse`
3. Go to **Providers** page
4. Click **New Provider**
5. Select **Deepgram Speech-to-Speech**
6. Fill in:
   - **Name**: `My Deepgram Provider`
   - **Deepgram API Key**: Your Deepgram API key
   - **Agent Prompt**: `You are a helpful assistant.`
   - **Greeting**: `Hello! How can I help you today?`
7. Click **Create**

### 2. Create an Agent

1. Go to **Agents** page
2. Click **New Agent**
3. Fill in:
   - **Name**: `Test Agent`
   - **Mode**: `STS`
   - **STS Provider**: Select your Deepgram provider
4. Click **Create**

### 3. Create a Phone Number

1. Go to **Numbers** page
2. Click **New Number**
3. Enter a phone number (e.g., `1001`)
4. Select your agent
5. Click **Create**

### 4. Test a Call

1. Open **Web Phone** at http://localhost:8080
2. Register with:
   - **SIP Server**: `localhost:8089`
   - **Username**: `1000` (default test user)
   - **Password**: `1000`
3. Dial your agent's number (e.g., `1001`)
4. The call should connect and you should hear the greeting

## Troubleshooting

### Docker Not Running

**Error**: "Docker is not running"

**Solution**: Start Docker Desktop and wait for it to fully start, then try again.

### Port Already in Use

**Error**: "Port is already allocated"

**Solution**: 
- Check if another service is using the port
- Stop conflicting services or change ports in `docker-compose-local-dev.yml`

### Services Not Connecting

**Error**: Backend can't connect to Asterisk or AMI

**Solution**:
1. Check if services are running: `docker-compose -f docker-compose-local-dev.yml ps`
2. Check service logs for errors
3. Verify network connectivity: `docker network ls` (should see `avr-local`)
4. Restart services: `.\stop_services.ps1` then `.\start_services.ps1`

### Agent Container Not Starting

**Error**: Agent fails to start when running

**Solution**:
1. Check Docker Desktop is running
2. Verify provider configuration is correct
3. Check backend logs for Docker errors
4. Ensure Deepgram API key is valid

## Network Configuration

Services communicate through the `avr-local` Docker network:

- **Backend** (running locally) connects to:
  - `localhost:8088` for Asterisk ARI
  - `localhost:6006` for AMI service
  - Docker socket for managing agent containers

- **Agent containers** (created dynamically) connect to:
  - `avr-asterisk:8088` for ARI (internal Docker network)
  - `avr-ami:6006` for AMI (internal Docker network)
  - `avr-sts-deepgram:6033` for STS (internal Docker network)

## Next Steps

Once all services are running:

1. Create providers for different AI services
2. Create agents with different configurations
3. Test call flows and agent interactions
4. Monitor logs for debugging
5. Develop new features with hot-reload enabled

For more information, see:
- [AVR Architecture Documentation](./AVR_ARCHITECTURE_ANALYSIS.md)
- [Local Development Setup](./LOCAL_DEVELOPMENT_SETUP.md)

