services:
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: always
    command:
      # Disable insecure API in production - use dashboard only if needed via secure route
      - "--api.insecure=false"
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Dedicated WebSocket entrypoint on port 8443 (HTTP routing with TLS termination)
      - "--entrypoints.websocket.address=:8443"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@digitalstorming.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Enable access logs for security monitoring
      - "--accesslog=true"
      - "--accesslog.format=json"
    ports:
      - "80:80"
      - "443:443"
      # Remove 8080 from public - Traefik dashboard not needed in production
      - "8443:8443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
    networks:
      - dsai

  dsai-asterisk:
    image: agentvoiceresponse/dsai-asterisk
    platform: linux/amd64
    container_name: dsai-asterisk
    restart: always
    ports:
      # AMI port - internal only, not exposed to host for security
      # SIP ports - only allow from SIP trunk provider via firewall
      - "5060:5060/udp"
      - "5060:5060/tcp"
      # RTP ports for media
      - "10000-10050:10000-10050/udp"
      # ARI/HTTP ports not exposed - accessed via Traefik for WebSocket
    labels:
      - "traefik.enable=true"
      # HTTP routing with TLS termination at Traefik for WebSocket
      # Traefik uses Let's Encrypt cert, forwards to Asterisk HTTP server port 8088
      # PJSIP WebSocket transport uses Asterisk's built-in HTTP WebSocket at /ws
      - "traefik.http.routers.asterisk-ws.rule=Host(`${DOMAIN:-ai.digitalstorming.com}`)"
      - "traefik.http.routers.asterisk-ws.entrypoints=websocket"
      - "traefik.http.routers.asterisk-ws.tls=true"
      - "traefik.http.routers.asterisk-ws.tls.certresolver=letsencrypt"
      - "traefik.http.services.asterisk-ws.loadbalancer.server.port=8088"
    volumes:
      - ./dsai-infra/asterisk/conf/manager.conf:/etc/asterisk/my_manager.conf
      - ./dsai-infra/asterisk/conf/pjsip.conf:/etc/asterisk/my_pjsip.conf
      - ./dsai-infra/asterisk/conf/extensions.conf:/etc/asterisk/my_extensions.conf
      - ./dsai-infra/asterisk/conf/queues.conf:/etc/asterisk/my_queues.conf
      - ./dsai-infra/asterisk/conf/ari.conf:/etc/asterisk/my_ari.conf
      - ./dsai-infra/asterisk/recordings:/var/spool/asterisk/monitor
    networks:
      - dsai

  dsai-ami:
    image: agentvoiceresponse/dsai-ami
    platform: linux/amd64
    container_name: dsai-ami
    restart: always
    environment:
      - PORT=6006
      - AMI_HOST=dsai-asterisk
      - AMI_PORT=5038
      - AMI_USERNAME=dsai
      - AMI_PASSWORD=dsai
    networks:
      - dsai

  dsai-core:
    image: agentvoiceresponse/dsai-core
    platform: linux/amd64
    container_name: dsai-core
    restart: always
    environment:
      - PORT=5001
      - WEBHOOK_URL=http://dsai-backend:3001/webhooks
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-webhook-secret-change-this}
    # Port 5001 only accessible within Docker network (not exposed to host)
    networks:
      - dsai

  dsai-llm-openai:
    image: agentvoiceresponse/dsai-llm-openai
    platform: linux/amd64
    container_name: dsai-llm-openai
    restart: always
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    networks:
      - dsai

  dsai-llm-anthropic:
    image: agentvoiceresponse/dsai-llm-anthropic
    platform: linux/amd64
    container_name: dsai-llm-anthropic
    restart: always
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    networks:
      - dsai

  dsai-tts-deepgram:
    image: agentvoiceresponse/dsai-tts-deepgram
    platform: linux/amd64
    container_name: dsai-tts-deepgram
    restart: always
    environment:
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY:-}
    networks:
      - dsai

  dsai-phone:
    build: ./dsai-phone
    image: dsai-phone:latest
    platform: linux/amd64
    container_name: dsai-phone
    restart: always
    labels:
      - "traefik.enable=true"
      # Main phone page route
      - "traefik.http.routers.phone.rule=Host(`${DOMAIN:-ai.digitalstorming.com}`) && Path(`/softphone`)"
      - "traefik.http.routers.phone.entrypoints=websecure"
      - "traefik.http.routers.phone.tls=true"
      - "traefik.http.routers.phone.tls.certresolver=letsencrypt"
      - "traefik.http.routers.phone.middlewares=phone-rewrite"
      - "traefik.http.middlewares.phone-rewrite.replacepath.path=/"
      # Phone HTML route (/phone -> index.html)
      - "traefik.http.routers.phone-html.rule=Host(`${DOMAIN:-ai.digitalstorming.com}`) && Path(`/phone`)"
      - "traefik.http.routers.phone-html.entrypoints=websecure"
      - "traefik.http.routers.phone-html.tls=true"
      - "traefik.http.routers.phone-html.tls.certresolver=letsencrypt"
      - "traefik.http.routers.phone-html.middlewares=phone-html-rewrite"
      - "traefik.http.middlewares.phone-html-rewrite.replacepath.path=/"
      - "traefik.http.routers.phone-html.priority=100"
      # Phone static assets route (phone.css, phone.js, sw.js, manifest.json, etc.)
      - "traefik.http.routers.phone-assets.rule=Host(`${DOMAIN:-ai.digitalstorming.com}`) && (Path(`/phone.css`) || Path(`/phone.light.css`) || Path(`/phone.dark.css`) || Path(`/phone.js`) || Path(`/sw.js`) || Path(`/manifest.json`) || PathPrefix(`/assets`) || PathPrefix(`/icons`) || PathPrefix(`/lang`) || PathPrefix(`/media`) || PathPrefix(`/avatars`))"
      - "traefik.http.routers.phone-assets.entrypoints=websecure"
      - "traefik.http.routers.phone-assets.tls=true"
      - "traefik.http.routers.phone-assets.tls.certresolver=letsencrypt"
      - "traefik.http.routers.phone-assets.priority=9999"
      - "traefik.http.routers.phone-assets.service=phone"
      - "traefik.http.services.phone.loadbalancer.server.port=80"
    networks:
      - dsai

  backend:
    build: ./dsai-app/backend
    container_name: dsai-backend
    restart: always
    environment:
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET:-super-secret-jwt-key-for-production-change-this}
      - FRONTEND_URL=${FRONTEND_URL:-https://ai.digitalstorming.com}
      - PUBLIC_URL=${PUBLIC_URL:-https://ai.digitalstorming.com}
      - PUBLIC_HOST=${PUBLIC_HOST:-ai.digitalstorming.com}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - WEBHOOK_URL=http://dsai-backend:3001/webhooks
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-webhook-secret-change-this}
      - ARI_URL=http://dsai-asterisk:8088/ari
      - ARI_USERNAME=dsai
      - ARI_PASSWORD=dsai
      - AMI_HOST=dsai-asterisk
      - AMI_PORT=5038
      - AMI_USERNAME=dsai
      - AMI_PASSWORD=dsai
      - AMI_SERVICE_URL=http://dsai-ami:6006
      - CORE_DEFAULT_IMAGE=agentvoiceresponse/dsai-core
      - DB_TYPE=sqlite
      - DB_DATABASE=/app/data/data.db
      - ASTERISK_CONFIG_PATH=/app/asterisk
      - ASTERISK_MONITOR_PATH=/app/recordings
      - NETWORK=dsai
      - PUBLIC_IP=${PUBLIC_IP:-}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${DOMAIN:-ai.digitalstorming.com}`) && PathPrefix(`/api/`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend.middlewares=backend-strip,api-ratelimit,api-nocache"
      - "traefik.http.middlewares.backend-strip.stripprefix.prefixes=/api/"
      # Rate limiting: 100 requests per second average, burst up to 200
      - "traefik.http.middlewares.api-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.burst=200"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.period=1s"
      # Disable caching for API responses
      - "traefik.http.middlewares.api-nocache.headers.customresponseheaders.Cache-Control=no-store, no-cache, must-revalidate"
      - "traefik.http.middlewares.api-nocache.headers.customresponseheaders.Pragma=no-cache"
      - "traefik.http.services.backend.loadbalancer.server.port=3001"
      # Twilio webhook router (no prefix stripping needed)
      - "traefik.http.routers.backend-twilio.rule=Host(`${DOMAIN:-ai.digitalstorming.com}`) && PathPrefix(`/twilio/`)"
      - "traefik.http.routers.backend-twilio.entrypoints=websecure"
      - "traefik.http.routers.backend-twilio.tls=true"
      - "traefik.http.routers.backend-twilio.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend-twilio.service=backend"
    volumes:
      - ./dsai-infra/asterisk/conf:/app/asterisk
      - ./data:/app/data
      - ./dsai-infra/asterisk/recordings:/app/recordings
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - dsai-asterisk
      - dsai-ami
    networks:
      - dsai

  frontend:
    build:
      context: ./dsai-app/frontend
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://ai.digitalstorming.com/api}
    container_name: dsai-frontend
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://ai.digitalstorming.com/api}
      - NEXT_PUBLIC_WEBRTC_CLIENT_URL=${NEXT_PUBLIC_WEBRTC_CLIENT_URL:-https://ai.digitalstorming.com/softphone}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN:-ai.digitalstorming.com}`)"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend.middlewares=security-headers"
      # Security headers middleware
      - "traefik.http.middlewares.security-headers.headers.framedeny=true"
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
    depends_on:
      - backend
    networks:
      - dsai

networks:
  dsai:
    external: true
